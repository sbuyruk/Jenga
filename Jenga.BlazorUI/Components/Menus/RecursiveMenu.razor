@using Jenga.Models.Common
@inject NavigationManager Nav

<ul class="recursive-menu">
    @foreach (var item in Items ?? Enumerable.Empty<MenuItem>())
    {
        <li class="menu-item @(item.IsExpanded ? "open" : "") @(item.IsActive ? "active" : "")">
            @if (!string.IsNullOrEmpty(item.Url) && (item.Children == null || !item.Children.Any()))
            {
                <NavLink href="@item.Url"
                         class="menu-header nav-link"
                         Match="NavLinkMatch.All">
                    <span class="menu-title">@item.Title</span>
                </NavLink>
            }
            else
            {

                <div class="menu-header"
                     @onclick="() => Toggle(item)"
                     @onclick:stopPropagation>
                    <span class="menu-title">@item.Title</span>
                    @if (item.Children?.Any() == true)
                    {
                        <span class="toggle-icon @(item.IsExpanded ? "rotated" : "")">
                            <svg class="menu-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                        </span>
                    }
                </div>
            }

            @if (item.IsExpanded && item.Children?.Any() == true)
            {
                <ul class="submenu show">
                    <RecursiveMenu Items="item.Children" />
                </ul>
            }
        </li>
    }
</ul>

@code {
    [Parameter]
    public List<MenuItem> Items { get; set; } = new();

    private void Toggle(MenuItem item)
    {
        item.IsExpanded = !item.IsExpanded;
    }

}

@* @rendermode InteractiveServer
@using Jenga.Models.Common
@using Jenga.BlazorUI.Components.Menus
@inject NavigationManager Nav
@inject ILogger<RecursiveMenu> Logger

<ul class="recursive-menu">
    @foreach (var item in Items!)
{
    <li class="menu-item @(item.IsExpanded ? "open" : "")">
        @if (!string.IsNullOrEmpty(item.Url) && (item.Children is null || item.Children.Count == 0))
        {
            <!-- Sadece alt menüsü olmayanlar NavLink ile yönlendirilir -->
            <NavLink href="@item.Url"
                     class="menu-header nav-link"
                     Match="NavLinkMatch.All">
                <span class="menu-title">@item.Title</span>
            </NavLink>
        }
        else
        {
            <!-- Alt menüsü olanlar sadece toggle edilir -->
            <div class="menu-header" @onclick="() => Toggle(item)">
                <span class="menu-title">@item.Title</span>

                @if (item.Children?.Any() == true)
                {
                    <span class="toggle-icon @(item.IsExpanded ? "rotated" : "")">
                        <svg class="menu-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M8 5v14l11-7z" />
                        </svg>
                    </span>
                }
            </div>
        }

        @if (item.IsExpanded && item.Children?.Any() == true)
        {
            <ul class="submenu show">
                <RecursiveMenu Items="item.Children" />
            </ul>
        }
    </li>
}

</ul>

@code {
    [Parameter]
    public List<MenuItem>? Items { get; set; }
    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        SetActiveRecursive(Items!);
        InvokeAsync(StateHasChanged); // Daha kontrollü render
    }
    // protected override void OnParametersSet()
    // {
    //     if (Items is not null)
    //         SetActiveRecursive(Items);
    // }


    // private void OnItemClick(MenuItem item)
    // {
    //     if (!string.IsNullOrWhiteSpace(item.Url) && (item.Children is null || item.Children.Count == 0))
    //     {
    //         Nav.NavigateTo(item.Url);
    //     }
    //     else
    //     {
    //         Toggle(item);
    //     }
    // }

    private void Toggle(MenuItem item)
    {
        item.IsExpanded = !item.IsExpanded;
    }

    private void SetActiveRecursive(List<MenuItem> items)
    {
        var fullUri = Nav.Uri.ToLowerInvariant();
        var currentUrl = Nav.ToBaseRelativePath(Nav.Uri).TrimStart('/').ToLowerInvariant();

        foreach (var item in items)
        {
            var normalizedItemUrl = item.Url?.TrimStart('/').ToLowerInvariant();
            item.IsActive = (!string.IsNullOrWhiteSpace(normalizedItemUrl)
                             && (currentUrl == normalizedItemUrl || fullUri.EndsWith(normalizedItemUrl)));

            if (item.Children?.Any() == true)
            {
                SetActiveRecursive(item.Children);
                if (item.Children.Any(c => c.IsActive))
                    item.IsActive = true;
            }
        }
    }
    protected override bool ShouldRender()
    {
        return Items is not null;
    }

    // public void Dispose()
    // {
    //     Nav.LocationChanged -= OnLocationChanged;
    // }
}

 *@