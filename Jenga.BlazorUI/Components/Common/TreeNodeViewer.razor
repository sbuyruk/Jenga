@using System
@using System.Linq
@using System.Threading.Tasks
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using Jenga.Models.Common
@typeparam T

<li>
    <div class="treeview-item @(IsSelected ? "selected" : "")" @onclick="HandleSelect">
        @if (Children?.Any() == true)
        {
            <span class="expand-icon" @onclick:stopPropagation="true" @onclick="ToggleExpand" style="margin-right:4px;cursor:pointer" role="button" aria-label="Genişlet daralt" tabindex="0">
                <i class="bi @(Item.IsExpanded ? "bi-dash-square" : "bi-plus-square")"></i>
            </span>
        }

        @if (string.IsNullOrEmpty(Label))
        {
            <span class="material-badge"
                  @oncontextmenu="HandleSubItemContextMenu"
                  @oncontextmenu:preventDefault="true"
                  role="button"
                  tabindex="0">
                <i class="bi bi-bag"></i>@(SubItemLabel)
            </span>
        }
        else
        {
            <span class="tree-label"
                  @oncontextmenu="HandleContextMenu"
                  @oncontextmenu:preventDefault="true"
                  role="button"
                  tabindex="0">
                @Label
            </span>
            @if (!string.IsNullOrWhiteSpace(Description))
            {
                <span class="tree-desc">@Description</span>
            }
            @if (ShowCreate)
            {
                <span class="create-icon" title="Alt kategori ekle" @onclick="() => OnCreate.InvokeAsync(Item)" role="button" tabindex="0">
                    <i class="bi bi-bag-plus"></i>
                </span>
            }
            @if (ShowEdit)
            {
                <span class="edit-icon" title="Düzenle" @onclick="() => OnEdit.InvokeAsync(Item)" role="button" tabindex="0">
                    <i class="bi bi-pencil-square"></i>
                </span>
            }
            @if (ShowDelete)
            {
                <span class="delete-icon" title="Sil" @onclick="() => OnDelete.InvokeAsync(Item)" role="button" tabindex="0">
                    <i class="bi bi-trash3-fill"></i>
                </span>
            }
        }

        @if (ShowContextMenu && ShowMenu)
        {
            <div>
                <div class="context-menu-overlay" @onclick="CloseContextMenu"></div>
                <div class="context-menu" role="menu" aria-label="Context menu">
                    @if (ShowCreate)
                    {
                        <div @onclick="HandleCreate" role="menuitem"><i class="bi bi-bag-plus"></i> Alt Kategori Tanımla</div>
                        <div @onclick="HandleSubItemCreate" role="menuitem"><i class="bi bi-bag-plus"></i> Yeni Malzeme Tanımla</div>
                    }
                    @if (ShowEdit)
                    {
                        <div @onclick="HandleEdit" role="menuitem"><i class="bi bi-pencil-square"></i> Düzenle</div>
                    }
                    @if (ShowDelete)
                    {
                        <div @onclick="HandleDelete" role="menuitem"><i class="bi bi-trash3-fill"></i> Sil</div>
                    }
                </div>
            </div>
        }
        else if (ShowSubItemMenu)
        {
            <div>
                <div class="context-menu-overlay" @onclick="CloseSubItemContextMenu"></div>
                <div class="context-menu"
                     style="position:fixed;top:@($"{SubItemMenuY}px");left:@($"{SubItemMenuX}px");z-index:1001;"
                     role="menu" aria-label="Sub item menu">
                    @if (ShowCreate)
                    {
                        <div @onclick="HandleSubItemCreate" role="menuitem"><i class="bi bi-bag-plus"></i>Yeni Malzeme</div>
                    }
                    @if (ShowEdit)
                    {
                        <div @onclick="HandleSubItemEdit" role="menuitem"><i class="bi bi-pencil-square"></i> Düzenle</div>
                    }
                    @if (ShowDelete)
                    {
                        <div @onclick="HandleSubItemDelete" role="menuitem"><i class="bi bi-trash3-fill"></i> Sil</div>
                    }
                </div>
            </div>
        }
    </div>

    @if (Children?.Any() == true && Item.IsExpanded)
    {
        <ul class="treeview-list">
            @foreach (var child in Children)
            {
                <TreeNodeViewer T="T"
                                Item="child"
                                SelectedItemId="@SelectedItemId"
                                SelectedDataKey="@SelectedDataKey"
                                OnSelect="OnSelect"
                                OnCreate="OnCreate"
                                OnEdit="OnEdit"
                                OnDelete="OnDelete"
                                LabelSelector="LabelSelector"
                                DescriptionSelector="DescriptionSelector"
                                SubItemLabelSelector="SubItemLabelSelector"
                                ChildrenSelector="ChildrenSelector"
                                ShowContextMenuSelector="ShowContextMenuSelector"
                                ShowCreateSelector="ShowCreateSelector"
                                ShowEditSelector="ShowEditSelector"
                                ShowDeleteSelector="ShowDeleteSelector"
                                OnSubItemCreate="OnSubItemCreate"
                                OnSubItemEdit="OnSubItemEdit"
                                OnSubItemDelete="OnSubItemDelete"
                                OnToggleExpand="OnToggleExpand" />
            }
        </ul>
    }
</li>

@code {
    [Parameter] public TreeItem<T> Item { get; set; } = default!;
    [Parameter] public EventCallback<TreeItem<T>> OnSelect { get; set; }
    [Parameter] public EventCallback<TreeItem<T>> OnCreate { get; set; }
    [Parameter] public EventCallback<TreeItem<T>> OnEdit { get; set; }
    [Parameter] public EventCallback<TreeItem<T>> OnDelete { get; set; }
    [Parameter] public Func<TreeItem<T>, string>? LabelSelector { get; set; }
    [Parameter] public Func<TreeItem<T>, string>? SubItemLabelSelector { get; set; }
    [Parameter] public Func<TreeItem<T>, string>? DescriptionSelector { get; set; }
    [Parameter] public Func<TreeItem<T>, IEnumerable<TreeItem<T>>>? ChildrenSelector { get; set; }
    [Parameter] public Func<TreeItem<T>, bool>? ShowContextMenuSelector { get; set; }
    [Parameter] public Func<TreeItem<T>, bool>? ShowCreateSelector { get; set; }
    [Parameter] public Func<TreeItem<T>, bool>? ShowEditSelector { get; set; }
    [Parameter] public Func<TreeItem<T>, bool>? ShowDeleteSelector { get; set; }
    [Parameter] public EventCallback<TreeItem<T>> OnSubItemCreate { get; set; }
    [Parameter] public EventCallback<TreeItem<T>> OnSubItemEdit { get; set; }
    [Parameter] public EventCallback<TreeItem<T>> OnSubItemDelete { get; set; }
    [Parameter] public string? SelectedItemId { get; set; }

    // New: selected data key propagated from parent
    [Parameter] public string? SelectedDataKey { get; set; }

    // New callback to request parent toggle the original item
    [Parameter] public EventCallback<string> OnToggleExpand { get; set; }

    private string Label => LabelSelector?.Invoke(Item) ?? Item?.Data?.ToString() ?? "";
    private string SubItemLabel => SubItemLabelSelector?.Invoke(Item) ?? "";
    private string Description => DescriptionSelector?.Invoke(Item) ?? "";
    private IEnumerable<TreeItem<T>>? Children => ChildrenSelector?.Invoke(Item);
    private bool ShowContextMenu => ShowContextMenuSelector?.Invoke(Item) ?? true;
    private bool ShowCreate => ShowCreateSelector?.Invoke(Item) ?? true;
    private bool ShowEdit => ShowEditSelector?.Invoke(Item) ?? true;
    private bool ShowDelete => ShowDeleteSelector?.Invoke(Item) ?? true;

    // IsSelected now checks node id OR stable data key match
    private bool IsSelected => Item.Id == SelectedItemId || (!string.IsNullOrEmpty(SelectedDataKey) && GetDataKey(Item) == SelectedDataKey);

    private bool ShowMenu { get; set; }
    private bool ShowSubItemMenu { get; set; }
    private double SubItemMenuX { get; set; }
    private double SubItemMenuY { get; set; }

    private async Task ToggleExpand()
    {
        if (Item == null) return;

        // Ask parent to toggle the *original* item by id so the source tree keeps state.
        if (OnToggleExpand.HasDelegate)
        {
            await OnToggleExpand.InvokeAsync(Item.Id);
            return;
        }

        // Fallback if parent doesn't support it (keeps previous behavior)
        Item.IsExpanded = !Item.IsExpanded;
    }

    private void HandleContextMenu(MouseEventArgs args)
    {
        if (!ShowContextMenu) return;
        ShowMenu = true;
        StateHasChanged();
    }

    private void CloseContextMenu()
    {
        ShowMenu = false;
        StateHasChanged();
    }

    private async Task HandleCreate()
    {
        ShowMenu = false;
        if (OnCreate.HasDelegate) await OnCreate.InvokeAsync(Item);
    }

    private async Task HandleEdit()
    {
        ShowMenu = false;
        if (OnEdit.HasDelegate) await OnEdit.InvokeAsync(Item);
    }

    private async Task HandleDelete()
    {
        ShowMenu = false;
        if (OnDelete.HasDelegate) await OnDelete.InvokeAsync(Item);
    }

    private void HandleSubItemContextMenu(MouseEventArgs e)
    {
        ShowSubItemMenu = true;
        SubItemMenuX = e.ClientX;
        SubItemMenuY = e.ClientY;
        StateHasChanged();
    }

    private void CloseSubItemContextMenu()
    {
        ShowSubItemMenu = false;
        StateHasChanged();
    }

    private async Task HandleSubItemCreate()
    {
        if (OnSubItemCreate.HasDelegate) await OnSubItemCreate.InvokeAsync(Item);
        CloseSubItemContextMenu();
        CloseContextMenu();
    }
    private async Task HandleSubItemEdit()
    {
        if (OnSubItemEdit.HasDelegate) await OnSubItemEdit.InvokeAsync(Item);
        CloseSubItemContextMenu();
    }
    private async Task HandleSubItemDelete()
    {
        if (OnSubItemDelete.HasDelegate) await OnSubItemDelete.InvokeAsync(Item);
        CloseSubItemContextMenu();
    }

    private async Task HandleSelect()
    {
        if (OnSelect.HasDelegate)
            await OnSelect.InvokeAsync(Item);
    }

    // Compute data key same way as parent (Category.Id, Material.Id, Id)
    private string GetDataKey(TreeItem<T>? item)
    {
        if (item == null) return string.Empty;
        var data = item.Data;
        if (data == null) return item.Id ?? string.Empty;

        var type = data.GetType();
        var prop = type.GetProperty("Category");
        if (prop != null)
        {
            var cat = prop.GetValue(data);
            if (cat != null)
            {
                var idProp = cat.GetType().GetProperty("Id");
                if (idProp != null)
                {
                    var val = idProp.GetValue(cat)?.ToString();
                    if (!string.IsNullOrEmpty(val)) return "category:" + val;
                }
            }
        }

        prop = type.GetProperty("Material");
        if (prop != null)
        {
            var mat = prop.GetValue(data);
            if (mat != null)
            {
                var idProp = mat.GetType().GetProperty("Id");
                if (idProp != null)
                {
                    var val = idProp.GetValue(mat)?.ToString();
                    if (!string.IsNullOrEmpty(val)) return "material:" + val;
                }
            }
        }

        var idP = type.GetProperty("Id");
        if (idP != null)
        {
            var val = idP.GetValue(data)?.ToString();
            if (!string.IsNullOrEmpty(val)) return "data:" + val;
        }

        return item.Id ?? string.Empty;
    }
}