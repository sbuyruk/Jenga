@page "/inventory/location-manager"
@rendermode InteractiveServer
@using Jenga.BlazorUI.Components.Inventory
@using Jenga.BlazorUI.Components.Common
@using Jenga.DataAccess.Services.Inventory
@using Jenga.Models.Common
@using Jenga.Models.Enums
@using Jenga.Models.Inventory
@using Jenga.Models.Helper
@using Jenga.Utility.Modal
@using Jenga.Utility.Toast
@using Microsoft.AspNetCore.Http
@inject ILocationService LocationService
@inject IJSRuntime JS
@inject IMaterialEntryService MaterialEntryService
@inject IMaterialExitService MaterialExitService
@inject IMaterialInventoryService MaterialInventoryService
@inject IModalService ModalService
@inject IToastService ToastService

<div class="navbar navbar-expand-lg bg-body-tertiary gap-5 mb-3 shadow-sm rounded py-2 px-3" style="min-height:56px;">
    <h3 class="mb-0 flex-grow-1">Lokasyon Yönetimi</h3>
    <input class="form-control" style="max-width: 250px;"
           placeholder="Lokasyon Ara..."
           @bind="searchTerm"
           @bind:event="oninput" />
    <button class="btn btn-success" @onclick="OpenNewLocationModal" type="button">
        <i class="bi bi-plus-lg"></i> Yeni Lokasyon
    </button>
</div>
<div class="treeview-container">
    <TreeView T="Location"
              Items="filteredTree"
              ItemTemplate="LocationTemplate"
              SelectedItem="selectedLocation"
              OnItemClick="EditLocation"
              OnDeleteClick="DeleteLocation"
              OnContextMenu="HandleContextMenu"
              OnAddChildClick="AddChildLocation"
              Selectable="true" />

    <LocationEditModal Location="selectedLocation?.Data"
                       IsOpen="isEditOpen"
                       ParentLocations="locations"
                       OnSave="OnModalSave"
                       OnClose="OnModalClose" />
</div>

@if (showContextMenu)
{
    <div>
        <div class="context-menu-overlay" @onclick="CloseContextMenu"></div>
        <div class="context-menu"
             style="position:fixed;top:@($"{contextMenuY}px");left:@($"{contextMenuX}px");z-index:1001;">
            <ul>
                <li @onclick="() => AddChildLocation(tree.FirstOrDefault(t => t.Data.Id == contextMenuNode.Id)!)">Altına Ekle</li>
                <li @onclick="() => EditLocation(tree.FirstOrDefault(t => t.Data.Id == contextMenuNode.Id)!)">Düzenle</li>
                <li @onclick="() => {
                    var item = tree.FirstOrDefault(t => t.Data.Id == contextMenuNode.Id);
                    if (item != null)
                    {
                        _ = DeleteLocation(item);
                    }
                }">Sil</li>
            </ul>
        </div>
    </div>
}

@code {
    private List<MaterialEntry> materialEntries { get; set; } = new();
    [Parameter] public EventCallback OnRefresh { get; set; }
    private bool _dataLoaded;
    List<Location> locations = new();
    List<TreeItem<Location>> tree = new();
    TreeItem<Location>? selectedLocation;
    bool isEditOpen = false;

    string searchTerm = "";

    List<TreeItem<Location>> filteredTree => TreeHelper.FilterTree(
        tree,
        item => item.Data.LocationName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
    );

    // Context menu state
    bool showContextMenu = false;
    double contextMenuX, contextMenuY;
    Location contextMenuNode;

    protected override async Task OnInitializedAsync()
    {
        locations = await LocationService.GetAllAsync();
        tree = TreeHelper.BuildGenericTree<Location, int>(
            locations,
            loc => loc.Id,
            loc => loc.ParentId,
            loc => new TreeItem<Location>
            {
                Data = loc,
                ShowCreateIcon = true,
                ShowEditIcon = true,
                ShowDeleteIcon = true
            }
        );
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_dataLoaded)
        {
            materialEntries = await MaterialEntryService.GetAllAsync();
            _dataLoaded = true;
            StateHasChanged();
            await JS.InvokeVoidAsync("initMaterialEntryTableWithExport");
        }
    }

    void EditLocation(TreeItem<Location> item)
    {
        selectedLocation = item;
        isEditOpen = true;
        CloseContextMenu();
        StateHasChanged();
    }

    async Task OnModalSave()
    {
        isEditOpen = false;
        if (selectedLocation?.Data != null)
        {
            if (selectedLocation.Data.Id == 0)
            {
                var saved = await LocationService.AddAsync(selectedLocation.Data);
                if (saved)
                {
                    locations.Add(selectedLocation.Data);
                }
            }
            else
            {
                await LocationService.UpdateAsync(selectedLocation.Data);
            }
        }
        locations = await LocationService.GetAllAsync();
        tree = TreeHelper.BuildGenericTree<Location, int>(
            locations,
            loc => loc.Id,
            loc => loc.ParentId,
            loc => new TreeItem<Location>
            {
                Data = loc,
                ShowCreateIcon = true,
                ShowEditIcon = true,
                ShowDeleteIcon = true
            }
        );
        StateHasChanged();
    }

    void OnModalClose()
    {
        isEditOpen = false;
    }

    private async Task OpenNewLocationModal()
    {
        selectedLocation = new TreeItem<Location>
        {
            Data = new Location(),
            ShowCreateIcon = true,
            ShowEditIcon = true,
            ShowDeleteIcon = true
        };
        isEditOpen = true;
    }

    string GetLocationIcon(Location loc)
    {
        if (loc.LocationType == LocationType.Building)
            return "bi bi-buildings";
        if (loc.LocationType == LocationType.Floor)
            return "bi bi-layers";
        if (loc.LocationType == LocationType.Warehouse)
            return "bi bi-box";
        if (loc.LocationType == LocationType.Room)
            return "bi bi-door-closed";
        if (loc.LocationType == LocationType.Cabinet)
            return "bi bi-window-split";
        if (loc.LocationType == LocationType.Shelf)
            return "bi bi-table";
        if (loc.Children?.Any() == true)
            return "bi bi-folder";
        return "bi bi-file-earmark";
    }

    private async Task DeleteLocation(TreeItem<Location> item)
    {
        CloseContextMenu();
        await Task.Yield();
        var (canDelete, reason) = await LocationService.CanDeleteAsync(item.Data.Id);
        if (!canDelete)
        {
            ToastService.ShowToast(reason ?? "Bilinmeyen bir hata oluştu", ToastType.Error, 5000);
            return;
        }

        ModalService.ShowConfirmation(
            "Silme Onayı",
            $"'{item.Data.LocationName ?? "Konum"}' kaydını silmek istediğinizden emin misiniz?",
        async result =>
        {
            if (result)
            {
                var deleted = await LocationService.DeleteAsync(item.Data);
                if (deleted)
                {
                    ToastService.ShowToast($"{item.Data.LocationName ?? "Konum"} silindi", ToastType.Success, 3000);
                    locations.Remove(item.Data);
                    tree = TreeHelper.BuildGenericTree<Location, int>(
                        locations,
                        loc => loc.Id,
                        loc => loc.ParentId,
                        loc => new TreeItem<Location>
                        {
                            Data = loc,
                            ShowCreateIcon = true,
                            ShowEditIcon = true,
                            ShowDeleteIcon = true
                        }
                    );
                    await OnRefresh.InvokeAsync();
                    StateHasChanged();
                }
                else
                {
                    ToastService.ShowToast($"Silme işlemi başarısız oldu", ToastType.Error, 3000);
                }
            }
        });
    }

    void HandleContextMenu((MouseEventArgs e, TreeItem<Location> item) args)
    {
        showContextMenu = true;
        contextMenuX = args.e.ClientX;
        contextMenuY = args.e.ClientY;
        contextMenuNode = args.item.Data;
        StateHasChanged();
    }
    void CloseContextMenu()
    {
        showContextMenu = false;
        StateHasChanged();
    }
    void AddChildLocation(TreeItem<Location> parent)
    {
        selectedLocation = new TreeItem<Location>
        {
            Data = new Location
            {
                ParentId = parent.Data.Id
            },
            ShowCreateIcon = true,
            ShowEditIcon = true,
            ShowDeleteIcon = true
        };
        isEditOpen = true;
        CloseContextMenu();
        StateHasChanged();
    }

    RenderFragment<Location> LocationTemplate => loc => @<span>
        <i class="@GetLocationIcon(loc) tree-icon"></i>
        <span title="@loc.Aciklama">@loc.LocationName</span>
    </span>;
}