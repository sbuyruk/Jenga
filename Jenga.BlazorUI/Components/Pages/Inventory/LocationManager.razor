@page "/inventory/location-manager"
@rendermode InteractiveServer

@using Jenga.BlazorUI.Components.Inventory
@using Jenga.BlazorUI.Components.Common
@using Jenga.DataAccess.Services.Inventory
@using Jenga.Models.Common
@using Jenga.Models.Enums
@using Jenga.Models.Inventory
@using Jenga.Models.Helper
@using Jenga.Utility.Modal
@using Jenga.Utility.Toast

@inject ILocationService LocationService
@inject IModalService ModalService
@inject IToastService ToastService

<div class="navbar navbar-expand-lg bg-body-tertiary gap-5 mb-3 shadow-sm rounded py-2 px-3" style="min-height:56px;">
    <h3 class="mb-0 flex-grow-1">Lokasyon Yönetimi</h3>
    <input class="form-control" style="max-width: 250px;"
           placeholder="Lokasyon Ara..."
           @bind="searchTerm"
           @bind:event="oninput" />
    <button class="btn btn-success" @onclick="OpenNewLocationModal" type="button">
        <i class="bi bi-plus-lg"></i> Yeni Lokasyon
    </button>
</div>
<div class="treeview-container">
    <TreeViewer T="Location"
                Items="tree"
                SearchTerm="@searchTerm"
                FilterFunc="(item, term) => item.Data.LocationName != null && item.Data.LocationName.Contains(term, StringComparison.OrdinalIgnoreCase)"
                OnEdit="EditLocation"
                OnDelete="DeleteLocation"
                OnCreate="AddChildLocation"
                LabelSelector="@(item => item.Data.LocationName)"
                DescriptionSelector="@(item => item.Data.Aciklama)"
                ChildrenSelector="@(item => item.Children)"
                ShowCreateSelector="@(item => item.ShowCreate)"
                ShowEditSelector="@(item => item.ShowEdit)"
                ShowDeleteSelector="@(item => item.ShowDelete)" />

    <LocationEditModal Location="selectedLocation?.Data"
                       IsOpen="isEditOpen"
                       ParentLocations="locations"
                       OnSave="OnModalSave"
                       OnClose="OnModalClose" />
</div>

@code {
    // Fields
    private List<Location> locations = new();
    private List<TreeItem<Location>> tree = new();
    private TreeItem<Location>? selectedLocation;
    private bool isEditOpen = false;
    private bool _dataLoaded = false;
    private string searchTerm = "";

    [Parameter] public EventCallback OnRefresh { get; set; }

    // Lifecycle
    protected override async Task OnInitializedAsync()
    {
        await RefreshData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_dataLoaded)
        {
            await RefreshData();
        }
    }

    // Data
    private async Task RefreshData()
    {
        var expandedMap = TreeHelper.CollectExpandedStates(tree);
        locations = await LocationService.GetAllAsync();
        _dataLoaded = true;
        tree = TreeHelper.BuildTree<Location>(
            locations,
            loc => loc.Id.ToString(),
            loc => loc.ParentId?.ToString()
        );
        TreeHelper.RestoreExpandedStates(tree, expandedMap);
        StateHasChanged();
    }

    // Event Handlers
    private void EditLocation(TreeItem<Location> item)
    {
        selectedLocation = item;
        isEditOpen = true;
        StateHasChanged();
    }

    private async Task OnModalSave()
    {
        isEditOpen = false;
        if (selectedLocation?.Data != null)
        {
            if (selectedLocation.Data.Id == 0)
            {
                var saved = await LocationService.AddAsync(selectedLocation.Data);
                if (saved)
                {
                    locations.Add(selectedLocation.Data);
                }
            }
            else
            {
                await LocationService.UpdateAsync(selectedLocation.Data);
            }
        }
        await RefreshData();
    }

    private void OnModalClose()
    {
        isEditOpen = false;
    }

    private async Task OpenNewLocationModal()
    {
        selectedLocation = new TreeItem<Location>
        {
            Data = new Location(),
            ShowCreate = true,
            ShowEdit = true,
            ShowDelete = true
        };
        isEditOpen = true;
    }

    private async Task DeleteLocation(TreeItem<Location> item)
    {
        var (canDelete, reason) = await LocationService.CanDeleteAsync(item.Data.Id);
        if (!canDelete)
        {
            ToastService.ShowToast(reason ?? "Bilinmeyen bir hata oluştu", ToastType.Error, 5000);
            return;
        }

        ModalService.ShowConfirmation(
            "Silme Onayı",
            $"'{item.Data.LocationName ?? "Konum"}' kaydını silmek istediğinizden emin misiniz?",
            async result =>
            {
                if (result)
                {
                    var deleted = await LocationService.DeleteAsync(item.Data);
                    if (deleted)
                    {
                        ToastService.ShowToast($"{item.Data.LocationName ?? "Konum"} silindi", ToastType.Success, 3000);
                        locations.Remove(item.Data);
                        await RefreshData();
                    }
                    else
                    {
                        ToastService.ShowToast($"Silme işlemi başarısız oldu", ToastType.Error, 3000);
                    }
                }
            });
    }

    private void AddChildLocation(TreeItem<Location> parent)
    {
        selectedLocation = new TreeItem<Location>
        {
            Data = new Location
            {
                ParentId = parent.Data.Id
            },
            ShowCreate = true,
            ShowEdit = true,
            ShowDelete = true
        };
        isEditOpen = true;
        StateHasChanged();
    }

    // Utility
    private string GetLocationIcon(Location loc)
    {
        return loc.LocationType switch
        {
            LocationType.Building => "bi bi-buildings",
            LocationType.Floor => "bi bi-layers",
            LocationType.Warehouse => "bi bi-box",
            LocationType.Room => "bi bi-door-closed",
            LocationType.Cabinet => "bi bi-window-split",
            LocationType.Shelf => "bi bi-table",
            _ when loc.Children?.Any() == true => "bi bi-folder",
            _ => "bi bi-file-earmark"
        };
    }
}