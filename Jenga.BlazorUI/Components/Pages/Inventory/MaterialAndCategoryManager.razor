@page "/inventory/material-and-category-manager"
@rendermode InteractiveServer
@using Jenga.BlazorUI.Components.Common
@using Jenga.BlazorUI.Components.Inventory
@using Jenga.DataAccess.Services.Inventory
@using Jenga.Models.Common
@using Jenga.Models.Helper
@using Jenga.Models.Inventory
@using Jenga.Utility.Modal
@using Jenga.Utility.Toast
@inject IToastService ToastService
@inject IModalService ModalService
@inject IMaterialEntryService MaterialEntryService
@inject IMaterialService MaterialService
@inject IMaterialUnitService MaterialUnitService
@inject ILocationService LocationService
@inject IMaterialCategoryService MaterialCategoryService
@inject IMaterialBrandService MaterialBrandService
@inject IMaterialModelService MaterialModelService
@inject IJSRuntime JS

<div class="navbar navbar-expand-lg bg-body-tertiary gap-5 mb-3 shadow-sm rounded py-2 px-3" style="min-height:56px;">
    <h3 class="mb-0 flex-grow-1">Malzeme ve Kategori Tanımları</h3>
    <input class="form-control" style="max-width: 250px;"
           placeholder="Malzeme Ara..."
           @bind="searchTerm"
           @bind:event="oninput" />
    <button class="btn btn-success" @onclick="OpenCreateModal" type="button">
        <i class="bi bi-plus-lg"></i> Yeni Malzeme Tanımla
    </button>
</div>
<div class="treeview-container">

    <TreeViewer T="MaterialCategoryNode"
                Items="filteredTree"
                LabelSelector="@(item => item.Data.Category?.CategoryName ?? "")"
                DescriptionSelector="@(item => item.Data.Category?.Aciklama ?? "")"
                SubItemLabelSelector="@(item => item.Data.Material.MaterialName??"")" 
                ChildrenSelector="@(item => item.Children)"
                ShowContextMenuSelector="@(item => item.ShowContextMenu)"
                ShowCreateSelector="@(item => item.ShowCreate)"
                ShowEditSelector="@(item => item.ShowEdit)"
                ShowDeleteSelector="@(item => item.ShowDelete)"
                OnCreate="HandleCreateMaterialCategory"
                OnEdit="HandleEditMaterialCategory"
                OnDelete="HandleDeleteMaterialCategory"
                OnSubItemCreate="HandleCreateMaterial" 
                OnSubItemEdit="HandleEditMaterial" 
                OnSubItemDelete="HandleDeleteMaterial" />

    <MaterialCategoryEditModal Category="selectedCategory"
                               IsOpen="isCategoryEditOpen"
                               ParentCategories="categories"
                               OnSave="OnModalCategorySave"
                               OnClose="OnModalCategoryClose" />

    <MaterialEditModal Material="selectedMaterial"
                       Categories="categories"
                       IsOpen="isMaterialEditOpen"
                       OnSave="OnModalMaterialSave"
                       OnClose="OnModalMaterialClose" />
</div>

@code {
    private List<MaterialCategory> categories = new();
    private List<Material> materials = new();
    private List<TreeItem<MaterialCategoryNode>> categoryTree = new();
    private bool _dataLoaded;

    MaterialCategory? selectedCategory;
    Material? selectedMaterial;
    bool isCategoryEditOpen = false;
    bool isMaterialEditOpen = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_dataLoaded)
        {
            categories = await MaterialCategoryService.GetAllAsync();
            materials = await MaterialService.GetAllAsync();
            categoryTree = BuildCategoryTreeWithMaterialsAsNodes(categories, materials);
            // categoryTree = BuildCategoryTree(categories, materials);
            _dataLoaded = true;
            StateHasChanged();
        }
    }

    public class MaterialCategoryNode
    {
        public MaterialCategory? Category { get; set; }
        public Material Material { get; set; } = new();
    }
    private List<TreeItem<MaterialCategoryNode>> BuildCategoryTreeWithMaterialsAsNodes(List<MaterialCategory> categories, List<Material> materials)
    {
        // 1. Create lookup1 for categories
        var lookup = categories.ToDictionary(c => c.Id, c =>
            new TreeItem<MaterialCategoryNode>
            {
                Data = new MaterialCategoryNode { Category = c },
                ShowCreate = true,
                ShowEdit = true,
                ShowDelete = true,
                Children = new List<TreeItem<MaterialCategoryNode>>()
            });

        // 2. Build category hierarchy
        foreach (var cat in categories)
        {
            if (cat.ParentCategoryId.HasValue && lookup.ContainsKey(cat.ParentCategoryId.Value))
                lookup[cat.ParentCategoryId.Value].Children.Add(lookup[cat.Id]);
        }

        // 3. Add materials as child nodes under their parent category
        foreach (var mat in materials)
        {
            if (lookup.ContainsKey(mat.CategoryId))
            {
                var materialNode = new TreeItem<MaterialCategoryNode>
                {
                    Data = new MaterialCategoryNode {Material =  mat  },
                    ShowCreate = true,
                    ShowEdit = true,
                    ShowDelete = true,
                    Children = new List<TreeItem<MaterialCategoryNode>>()
                };
                lookup[mat.CategoryId].Children.Add(materialNode);
            }
        }

        // 4. Return root nodes (categories without parent)
        return lookup.Values.Where(n => n.Data.Category?.ParentCategoryId == null).ToList();
    }
    //search
    string searchTerm = "";

    List<TreeItem<MaterialCategoryNode>> filteredTree => TreeHelper.FilterTree(
        categoryTree,
        item =>
            (item.Data.Category != null && item.Data.Category.CategoryName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
            (item.Data.Material != null && item.Data.Material.MaterialName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
    );

    // Event Handlers MaterialCategory
    private async Task HandleCreateMaterialCategory(TreeItem<MaterialCategoryNode> item)
    {
        selectedCategory = new MaterialCategory
        {
            ParentCategoryId = item.Data.Category?.Id
        };
        isCategoryEditOpen = true;
        isMaterialEditOpen = false;
        StateHasChanged();
    }

    private void HandleEditMaterialCategory(TreeItem<MaterialCategoryNode> item)
    {
        selectedCategory = item.Data.Category;
        isCategoryEditOpen = true;
        isMaterialEditOpen = false;
        StateHasChanged();
    }

    private async Task HandleDeleteMaterialCategory(TreeItem<MaterialCategoryNode> item)
    {
        if (item?.Data.Category == null)
        {
            ToastService.ShowToast("Kategori bilgisi bulunamadı", ToastType.Error, 5000);
            return;
        }
        (bool canDelete, string? reason) = await MaterialCategoryService.CanDeleteAsync(item.Data.Category.Id);
        if (!canDelete)
        {
            ToastService.ShowToast(reason ?? "Bilinmeyen bir hata oluştu", ToastType.Error, 5000);
            return;
        }
        string categoryName = item.Data.Category.CategoryName ?? "Kategori";
        ModalService.ShowConfirmation(
            "Silme Onayı",
            $"'{categoryName}' kaydını silmek istediğinizden emin misiniz?",
            async result =>
            {
                if (result)
                {
                    var deleted = await MaterialCategoryService.DeleteAsync(item.Data.Category.Id);
                    if (deleted)
                    {
                        ToastService.ShowToast($"{categoryName} silindi", ToastType.Success, 3000);
                        categories = await MaterialCategoryService.GetAllAsync();
                        categoryTree = BuildCategoryTreeWithMaterialsAsNodes(categories, materials);
                        // categoryTree = BuildCategoryTree(categories, materials);
                        StateHasChanged();
                    }
                    else
                    {
                        ToastService.ShowToast($"Silme işlemi başarısız oldu", ToastType.Error, 3000);
                    }
                }
            });
    }

    private async Task OpenCreateModal()
    {
        selectedCategory = new MaterialCategory();
        isCategoryEditOpen = true;
        isMaterialEditOpen = false;
        selectedMaterial = null;
        StateHasChanged();
    }

    private async Task OnModalCategorySave()
    {
        isCategoryEditOpen = false;
        if (selectedCategory != null)
        {
            if (selectedCategory.Id == 0)
            {
                await MaterialCategoryService.AddAsync(selectedCategory);
            }
            else
            {
                await MaterialCategoryService.UpdateAsync(selectedCategory);
            }
        }
        categories = await MaterialCategoryService.GetAllAsync();
        categoryTree = BuildCategoryTreeWithMaterialsAsNodes(categories, materials);
        // categoryTree = BuildCategoryTree(categories, materials);
        selectedCategory = null;
        StateHasChanged();
    }

    private async Task OnModalMaterialSave()
    {
        if (selectedMaterial != null)
        {
            if (selectedMaterial.Id == 0)
                await MaterialService.AddAsync(selectedMaterial);
            else
                await MaterialService.UpdateAsync(selectedMaterial);
        }
        isMaterialEditOpen = false;
        selectedMaterial = null;
        materials = await MaterialService.GetAllAsync();
        categoryTree = BuildCategoryTreeWithMaterialsAsNodes(categories, materials);
        // categoryTree = BuildCategoryTree(categories, materials);
        StateHasChanged();
    }

    private void OnModalCategoryClose()
    {
        isCategoryEditOpen = false;
        selectedCategory = null;
    }

    private void OnModalMaterialClose()
    {
        isMaterialEditOpen = false;
        selectedMaterial = null;
    }
    // Event Handlers Material
    private async Task HandleCreateMaterial(TreeItem<MaterialCategoryNode> item)
    {
        int categoryId = item.Data.Category != null
            ? item.Data.Category.Id
            : item.Data.Material.CategoryId;

        selectedMaterial = new Material
        {
            CategoryId = categoryId
        };
        isCategoryEditOpen = false;
        isMaterialEditOpen = true;
        StateHasChanged();
    }
    private void HandleEditMaterial(TreeItem<MaterialCategoryNode> item)
    {
        selectedMaterial = item.Data.Material;
        isCategoryEditOpen = false;
        isMaterialEditOpen = true;
        StateHasChanged();
    }
    private async Task HandleDeleteMaterial(TreeItem<MaterialCategoryNode> item)
    {
        if (item?.Data.Material == null)
        {
            ToastService.ShowToast("Malzeme bilgisi bulunamadı", ToastType.Error, 5000);
            return;
        }
        (bool canDelete, string? reason) = await MaterialService.CanDeleteAsync(item.Data.Material.Id);
        if (!canDelete)
        {
            ToastService.ShowToast(reason ?? "Bilinmeyen bir hata oluştu", ToastType.Error, 5000);
            return;
        }
        string materialName = item.Data.Material.MaterialName ?? "Malzeme";
        ModalService.ShowConfirmation(
            "Silme Onayı",
            $"'{materialName}' kaydını silmek istediğinizden emin misiniz?",
            async result =>
            {
                if (result)
                {
                    var deleted = await MaterialService.DeleteAsync(item.Data.Material.Id);
                    if (deleted)
                    {
                        ToastService.ShowToast($"{materialName} silindi", ToastType.Success, 3000);
                        materials = await MaterialService.GetAllAsync();
                        categoryTree = BuildCategoryTreeWithMaterialsAsNodes(categories, materials);
                        StateHasChanged();
                    }
                    else
                    {
                        ToastService.ShowToast($"Silme işlemi başarısız oldu", ToastType.Error, 3000);
                    }
                }
            }
        );
    }
}