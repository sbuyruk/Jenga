@page "/inventory/material-and-category-manager"
@rendermode InteractiveServer

@using Jenga.BlazorUI.Components.Common
@using Jenga.BlazorUI.Components.Inventory
@using Jenga.DataAccess.Services.Inventory
@using Jenga.Models.Common
@using Jenga.Models.Helper
@using Jenga.Models.Inventory
@using Jenga.Utility.Modal
@using Jenga.Utility.Toast

@inject IToastService ToastService
@inject IModalService ModalService
@inject IMaterialEntryService MaterialEntryService
@inject IMaterialService MaterialService
@inject IMaterialUnitService MaterialUnitService
@inject ILocationService LocationService
@inject IMaterialCategoryService MaterialCategoryService
@inject IMaterialBrandService MaterialBrandService
@inject IMaterialModelService MaterialModelService
@inject IJSRuntime JS

<div class="navbar navbar-expand-lg bg-body-tertiary gap-5 mb-3 shadow-sm rounded py-2 px-3" style="min-height:56px;">
    <h3 class="mb-0 flex-grow-1">Malzeme ve Kategori Tanımları</h3>
    <input class="form-control" style="max-width: 250px;"
           placeholder="Malzeme Ara..."
           @bind="searchTerm"
           @bind:event="oninput" />
    <button class="btn btn-success" @onclick="OpenCreateModal" type="button">
        <i class="bi bi-plus-lg"></i> Yeni Malzeme Tanımla
    </button>
</div>

<div class="treeview-container">
    <TreeViewer T="MaterialCategoryNode"
                Items="categoryTree"
                SearchTerm="@searchTerm"
                FilterFunc="(item, term) =>
                                    (item.Data.Category != null && item.Data.Category.CategoryName.Contains(term, StringComparison.OrdinalIgnoreCase)) ||
                                    (item.Data.Material != null && item.Data.Material.MaterialName.Contains(term, StringComparison.OrdinalIgnoreCase))"
                LabelSelector="@(item => item.Data.Category?.CategoryName ?? "")"
                DescriptionSelector="@(item => item.Data.Category?.Aciklama ?? "")"
                SubItemLabelSelector="@(item => item.Data.Material.MaterialName ?? "")"
                ChildrenSelector="@(item => item.Children)"
                ShowContextMenuSelector="@(item => item.ShowContextMenu)"
                ShowCreateSelector="@(item => item.ShowCreate)"
                ShowEditSelector="@(item => item.ShowEdit)"
                ShowDeleteSelector="@(item => item.ShowDelete)"
                OnCreate="HandleCreateMaterialCategory"
                OnEdit="HandleEditMaterialCategory"
                OnDelete="HandleDeleteMaterialCategory"
                OnSubItemCreate="HandleCreateMaterial"
                OnSubItemEdit="HandleEditMaterial"
                OnSubItemDelete="HandleDeleteMaterial" />

    <MaterialCategoryEditModal Category="selectedCategory"
                               IsOpen="isCategoryEditOpen"
                               ParentCategories="categories"
                               OnSave="OnModalCategorySave"
                               OnClose="OnModalCategoryClose" />

    <MaterialEditModal Material="selectedMaterial"
                       Categories="categories"
                       IsOpen="isMaterialEditOpen"
                       OnSave="OnModalMaterialSave"
                       OnClose="OnModalMaterialClose" />
</div>

@code {
    // Fields
    private List<MaterialCategory> categories = new();
    private List<Material> materials = new();
    private List<TreeItem<MaterialCategoryNode>> categoryTree = new();
    private bool _dataLoaded;
    private string searchTerm = "";

    private MaterialCategory? selectedCategory;
    private Material? selectedMaterial;
    private bool isCategoryEditOpen = false;
    private bool isMaterialEditOpen = false;

    // Lifecycle
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_dataLoaded)
        {
            await RefreshData();
            _dataLoaded = true;
            StateHasChanged();
        }
    }

    // Data
    private async Task RefreshData()
    {
        var expandedMap = TreeHelper.CollectExpandedStates(categoryTree);
        categories = await MaterialCategoryService.GetAllAsync();
        materials = await MaterialService.GetAllAsync();

        // Kategorileri MaterialCategoryNode'a dönüştür
        var categoryNodes = categories.Select(c => new MaterialCategoryNode { Category = c }).ToList();

        // Kategori ağacını oluştur
        categoryTree = TreeHelper.BuildTree<MaterialCategoryNode>(
            categoryNodes,
            node => node.Category.Id.ToString(),
            node => node.Category.ParentCategoryId?.ToString()
        );

        // Malzemeleri ilgili kategoriye ekle
        foreach (var mat in materials)
        {
            var parentId = mat.CategoryId.ToString();
            var parent = categoryTree.FirstOrDefault(n => n.Id == parentId);
            if (parent != null)
            {
                var materialNode = new TreeItem<MaterialCategoryNode>
                {
                    Id = "mat-" + mat.Id.ToString(),
                    Data = new MaterialCategoryNode { Material = mat },
                    ShowCreate = true,
                    ShowEdit = true,
                    ShowDelete = true,
                    Children = new List<TreeItem<MaterialCategoryNode>>()
                };
                parent.Children.Add(materialNode);
            }
        }

        TreeHelper.RestoreExpandedStates(categoryTree, expandedMap);
        StateHasChanged();
    }

    // Models
    public class MaterialCategoryNode
    {
        public MaterialCategory? Category { get; set; }
        public Material Material { get; set; } = new();
    }

    // Event Handlers - Category
    private async Task HandleCreateMaterialCategory(TreeItem<MaterialCategoryNode> item)
    {
        selectedCategory = new MaterialCategory
        {
            ParentCategoryId = item.Data.Category?.Id
        };
        isCategoryEditOpen = true;
        isMaterialEditOpen = false;
        StateHasChanged();
    }

    private void HandleEditMaterialCategory(TreeItem<MaterialCategoryNode> item)
    {
        selectedCategory = item.Data.Category;
        isCategoryEditOpen = true;
        isMaterialEditOpen = false;
        StateHasChanged();
    }

    private async Task HandleDeleteMaterialCategory(TreeItem<MaterialCategoryNode> item)
    {
        if (item?.Data.Category == null)
        {
            ToastService.ShowToast("Kategori bilgisi bulunamadı", ToastType.Error, 5000);
            return;
        }
        (bool canDelete, string? reason) = await MaterialCategoryService.CanDeleteAsync(item.Data.Category.Id);
        if (!canDelete)
        {
            ToastService.ShowToast(reason ?? "Bilinmeyen bir hata oluştu", ToastType.Error, 5000);
            return;
        }
        string categoryName = item.Data.Category.CategoryName ?? "Kategori";
        ModalService.ShowConfirmation(
            "Silme Onayı",
            $"'{categoryName}' kaydını silmek istediğinizden emin misiniz?",
            async result =>
            {
                if (result)
                {
                    var deleted = await MaterialCategoryService.DeleteAsync(item.Data.Category.Id);
                    if (deleted)
                    {
                        ToastService.ShowToast($"{categoryName} silindi", ToastType.Success, 3000);
                        categories = await MaterialCategoryService.GetAllAsync();
                        await RefreshData();
                        StateHasChanged();
                    }
                    else
                    {
                        ToastService.ShowToast($"Silme işlemi başarısız oldu", ToastType.Error, 3000);
                    }
                }
            });
    }

    // Event Handlers - Modal
    private async Task OpenCreateModal()
    {
        selectedCategory = new MaterialCategory();
        isCategoryEditOpen = true;
        isMaterialEditOpen = false;
        selectedMaterial = null;
        StateHasChanged();
    }

    private async Task OnModalCategorySave()
    {
        isCategoryEditOpen = false;
        if (selectedCategory != null)
        {
            if (selectedCategory.Id == 0)
                await MaterialCategoryService.AddAsync(selectedCategory);
            else
                await MaterialCategoryService.UpdateAsync(selectedCategory);
        }
        await RefreshData();
        selectedCategory = null;
        StateHasChanged();
    }

    private async Task OnModalMaterialSave()
    {
        if (selectedMaterial != null)
        {
            if (selectedMaterial.Id == 0)
                await MaterialService.AddAsync(selectedMaterial);
            else
                await MaterialService.UpdateAsync(selectedMaterial);
        }
        isMaterialEditOpen = false;
        selectedMaterial = null;
        await RefreshData();
        StateHasChanged();
    }

    private void OnModalCategoryClose()
    {
        isCategoryEditOpen = false;
        selectedCategory = null;
    }

    private void OnModalMaterialClose()
    {
        isMaterialEditOpen = false;
        selectedMaterial = null;
    }

    // Event Handlers - Material
    private async Task HandleCreateMaterial(TreeItem<MaterialCategoryNode> item)
    {
        int categoryId = item.Data.Category != null
            ? item.Data.Category.Id
            : item.Data.Material.CategoryId;

        selectedMaterial = new Material
        {
            CategoryId = categoryId
        };
        isCategoryEditOpen = false;
        isMaterialEditOpen = true;
        StateHasChanged();
    }

    private void HandleEditMaterial(TreeItem<MaterialCategoryNode> item)
    {
        selectedMaterial = item.Data.Material;
        isCategoryEditOpen = false;
        isMaterialEditOpen = true;
        StateHasChanged();
    }

    private async Task HandleDeleteMaterial(TreeItem<MaterialCategoryNode> item)
    {
        if (item?.Data.Material == null)
        {
            ToastService.ShowToast("Malzeme bilgisi bulunamadı", ToastType.Error, 5000);
            return;
        }
        (bool canDelete, string? reason) = await MaterialService.CanDeleteAsync(item.Data.Material.Id);
        if (!canDelete)
        {
            ToastService.ShowToast(reason ?? "Bilinmeyen bir hata oluştu", ToastType.Error, 5000);
            return;
        }
        string materialName = item.Data.Material.MaterialName ?? "Malzeme";
        ModalService.ShowConfirmation(
            "Silme Onayı",
            $"'{materialName}' kaydını silmek istediğinizden emin misiniz?",
            async result =>
            {
                if (result)
                {
                    var deleted = await MaterialService.DeleteAsync(item.Data.Material.Id);
                    if (deleted)
                    {
                        ToastService.ShowToast($"{materialName} silindi", ToastType.Success, 3000);
                        await RefreshData();
                        StateHasChanged();
                    }
                    else
                    {
                        ToastService.ShowToast($"Silme işlemi başarısız oldu", ToastType.Error, 3000);
                    }
                }
            }
        );
    }
}