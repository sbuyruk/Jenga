@page "/inventory/materialentry-and-exit-manager"
@rendermode InteractiveServer

@using Jenga.BlazorUI.Components.Common
@using Jenga.BlazorUI.Components.Inventory
@using Jenga.DataAccess.Services.Inventory
@using Jenga.Models.Common
@using Jenga.Models.Helper
@using Jenga.Models.Inventory
@using Jenga.Utility.Modal
@using Jenga.Utility.Toast

@inject IToastService ToastService
@inject IModalService ModalService
@inject IMaterialService MaterialService
@inject IMaterialInventoryService MaterialInventoryService
@inject IMaterialBrandService MaterialBrandService
@inject IMaterialModelService MaterialModelService
@inject IMaterialCategoryService MaterialCategoryService
@inject IMaterialUnitService MaterialUnitService
@inject ILocationService LocationService
@inject IMaterialEntryService MaterialEntryService
@inject IMaterialExitService MaterialExitService
@inject IHttpContextAccessor httpContextAccessor
@inject IMaterialMovementService MaterialMovementService


<div class="row g-4 " style=" height:90vh;">
    <!-- LEFT: TreeViewer -->
 <div class="col-md-5 " style="height:100%">
        <h5 class="mb-0">Malzeme Cinsleri & Malzemeler </h5>
        <div class="mt-3 d-flex gap-2">
            <input class="form-control form-control-sm" placeholder="Malzeme Ara..." @bind="searchTerm" @bind:event="oninput" />
            <button class="btn btn-sm btn-outline-secondary" @onclick="RefreshData">Yenile</button>
            <button class="btn btn-sm btn-outline-secondary" @onclick="ClearSearch">Temizle</button>
        </div>
        <div class="card shadow-sm mt-1 " style="height: 90%;">
            <div class="card-body">
                <TreeViewer T="MaterialCategoryNode"
                            Items="categoryTree"
                            SearchTerm="@searchTerm"
                            FilterFunc="@filter"
                            LabelSelector="@(item => item.Data.Category?.CategoryName ?? "")"
                            DescriptionSelector="@(item => item.Data.Category?.Aciklama ?? "")"
                            SubItemLabelSelector="@(item => item.Data.Material?.MaterialName ?? "")"
                            ChildrenSelector="@(item => item.Children)"
                            ShowContextMenuSelector="@(item => item.ShowContextMenu)"
                            ShowCreateSelector="@(item => item.ShowCreate)"
                            ShowEditSelector="@(item => item.ShowEdit)"
                            ShowDeleteSelector="@(item => item.ShowDelete)"
                            SortSelector='@(item => item.Data.Category?.CategoryName ?? item.Data.Material?.MaterialName ?? "")'
                            SortAscending="@sortAscending" SortAscendingChanged="@(v => sortAscending = v)"
                            OnSubItemEdit="HandleEditMaterial"
                            OnSubItemCreate="HandleCreateMaterial"
                            OnEdit="HandleEditCategory"
                            OnCreate="HandleCreateCategory"
                            OnDelete="HandleDeleteCategory"
                            OnSelect="HandleNodeSelect" />
            </div>
        </div>
    </div>

    <!-- RIGHT -->
    <div class="col-md-7">
        <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="mb-0">Envanter İşlemleri</h5>
        </div>

        <div class="card p-3 mb-3" >
            <div class="row align-items-center">
                <div class="col-12" id="MaterialCards">
                    @if (SelectedMaterial != null)
                    {
                        <MaterialLocationGrid SelectedMaterial="SelectedMaterial"
                                              SelectedMaterialStock="SelectedMaterialStock"
                                              MaterialUnitSymbol="@GetSelectedMaterialUnitSymbol()"
                                              SelectedMaterialLocations="selectedMaterialLocations"
                                              SelectedLocationId="selectedLocationId"
                                              AllCategories="categories"
                                              AllLocations="locations"
                                              OnStartEntry="@(args => { StartEntry(args.Item1, args.Item2); return Task.CompletedTask; })"
                                              OnStartExit="@(args => { StartExit(args.Item1, args.Item2); return Task.CompletedTask; })"
                                              OnStartTransfer="@(args => { StartTransfer(args.Item1, args.Item2); return Task.CompletedTask; })"
                                              OnCategoryClick="SelectCategoryCard" />
                    }
                    else
                    {
                        <CategoryMaterialGrid DisplayedCategory="displayedCategory"
                                              CategoryCards="categoryCards"
                                              MaterialCards="materialCards"
                                              AllCategories="categories"
                                              AllMaterials="materials"
                                              OnCategoryClick="SelectCategoryCard"
                                              OnOpenMaterial="SelectMaterialFromCard"
                                              OnOpenMaterialEdit="OpenMaterialFromCard"
                                              OnOpenEntry="OpenEntryModalWithMaterial"
                                              MaterialUnits="materialUnits"
                                              MaterialInventories="materialInventories" />
                    }
                </div>

                <div class="col">

                    @if (materialTransactions.Any())
                    {
                        <div class="text-muted small">Son işlemler (Giriş/Çıkış/Transfer)</div>
                        <ul class="list-unstyled mb-0 small">
                            @foreach (var tx in materialTransactions.Take(6))
                            {

                                <li>
                                    <span class="fw-semibold">@tx.Type</span>
                                    <span class="text-muted"> — @tx.Date.ToString("dd/MM/yyyy")</span>
                                    <span class="small text-muted">
                                        @tx.MaterialName @($"{(tx.IsIncrease ? "+" : "-")}{tx.Quantity} {tx.UnitName} ")@tx.LocationName
                                        @if (tx.Type == "Çıkış" && !string.IsNullOrWhiteSpace(tx.MovementTypeRaw))
                                        {
                                            <text> — @tx.MovementTypeRaw</text>
                                        }
                                    </span>
                                </li>
                            }
                        </ul>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- existing modals kept as-is -->
<MaterialEntryEditModal MaterialEntry="editingEntry"
                        Materials="materials"
                        MaterialUnits="materialUnits"
                        Locations="locations"
                        IsOpen="isEntryOpen"
                        OnSave="OnEntryModalSave"
                        OnClose="CloseEntryModal" />

<MaterialExitEditModal MaterialExit="editingExit"
                       Materials="materials"
                       MaterialUnits="materialUnits"
                       Locations="locations"
                       MaterialInventories="materialInventories"
                       IsOpen="isExitOpen"
                       OnSave="OnExitModalSave"
                       OnClose="CloseExitModal" />

<MaterialCategoryEditModal Category="selectedCategory"
                           IsOpen="isCategoryEditOpen"
                           ParentCategories="categories"
                           OnSave="OnCategoryModalSave"
                           OnClose="CloseCategoryModal" />

<MaterialEditModal Material="editingMaterial"
                   Categories="categories"
                   IsOpen="isMaterialEditOpen"
                   OnSave="OnMaterialModalSave"
                   OnClose="CloseMaterialModal"
                   Brands="brands"
                   Models="models"
                   MaterialUnits="materialUnits" />

@code {
    // Models for page
    private List<TreeItem<MaterialCategoryNode>> categoryTree = new();
    private List<Material> materials = new();
    private List<MaterialUnit> materialUnits = new();
    private List<Location> locations = new();

    private List<MaterialCategory> categories { get; set; } = new();
    private List<MaterialBrand> brands { get; set; } = new();
    private List<MaterialModel> models { get; set; } = new();

    // Local state for rendered material cards (legacy)
    private List<Material> materialCards = new();

    // New: category cards when a category node is selected
    private List<MaterialCategory> categoryCards = new();

    // New: per-location stock cards for the selected material (uses shared viewmodel)
    private List<MaterialLocationCard> selectedMaterialLocations = new();

    // New: recent transactions for selected material (Entry/Exit/Transfer) (uses shared viewmodel)
    private List<MaterialTransactionView> materialTransactions = new();

    // The category currently shown as the header for cards (if any)
    private MaterialCategory? displayedCategory =new MaterialCategory();
   
    private string searchTerm = "";
    private bool sortAscending = true;

    private Material? SelectedMaterial;
    private Material? editingMaterial;
    private int SelectedMaterialStock => selectedMaterialLocations.Sum(x => x.Quantity);

    // Selected location id so we can highlight clicked location
    private int? selectedLocationId = null;

    // Entry modal state using provided component
    private bool isEntryOpen = false;
    private MaterialEntry? editingEntry;

    // Exit modal state
    private bool isExitOpen = false;
    private MaterialExit? editingExit;

    // Material/Category edit modals (reuse existing)
    private bool isCategoryEditOpen = false;
    private MaterialCategory? selectedCategory;
    private bool isMaterialEditOpen = false;

    // New: loaded material inventories
    private List<MaterialInventory> materialInventories = new();

    protected override async Task OnInitializedAsync()
    {
        await RefreshData();
    }

    private async Task RefreshData()
    {
        categories = await MaterialCategoryService.GetAllAsync();
        materials = await MaterialService.GetAllAsync();
        brands = await MaterialBrandService.GetAllAsync();
        models = await MaterialModelService.GetAllAsync();
        materialUnits = await MaterialUnitService.GetAllAsync();
        locations = await LocationService.GetAllAsync();

        // yükle: MaterialInventory
        materialInventories = await MaterialInventoryService.GetAllAsync();

        var categoryNodes = categories.Select(c => new MaterialCategoryNode { Category = c }).ToList();

        categoryTree = TreeHelper.BuildTree<MaterialCategoryNode>(
            categoryNodes,
            node => node.Category.Id.ToString(),
            node => node.Category.ParentCategoryId?.ToString()
        );

        foreach (var mat in materials)
        {
            var parentId = mat.CategoryId.ToString();
            var parent = FindNodeById(categoryTree, parentId);
            if (parent != null)
            {
                parent.Children.Add(new TreeItem<MaterialCategoryNode>
                {
                    Id = "mat-" + mat.Id,
                    Data = new MaterialCategoryNode { Material = mat },
                    ShowCreate = true,
                    ShowEdit = true,
                    ShowDelete = true,
                    Children = new List<TreeItem<MaterialCategoryNode>>()
                });
            }
        }

        // On initial load show top-level categories (ParentCategoryId ==0)
        categoryCards = categories?.Where(c => (c.ParentCategoryId ??0) ==0).ToList() ?? new List<MaterialCategory>();
        // Clear material selection so category view is visible
        materialCards.Clear();
        SelectedMaterial = null;
        selectedMaterialLocations.Clear();
        materialTransactions.Clear();
    }

    private TreeItem<MaterialCategoryNode>? FindNodeById(List<TreeItem<MaterialCategoryNode>> nodes, string id)
    {
        foreach (var node in nodes)
        {
            if (node.Id == id)
                return node;
            var found = FindNodeById(node.Children, id);
            if (found != null) return found;
        }
        return null;
    }

    private Func<TreeItem<MaterialCategoryNode>, string, bool> filter = (item, term) =>
        (item.Data.Category != null && item.Data.Category.CategoryName.Contains(term ?? "", StringComparison.OrdinalIgnoreCase)) ||
        (item.Data.Material != null && item.Data.Material.MaterialName.Contains(term ?? "", StringComparison.OrdinalIgnoreCase));

    // Tree events that open material modal
    private void HandleEditMaterial(TreeItem<MaterialCategoryNode> item)
    {
        editingMaterial = item.Data.Material;
        isCategoryEditOpen = false;
        isMaterialEditOpen = true;
        StateHasChanged();
    }

    private Task HandleCreateMaterial(TreeItem<MaterialCategoryNode> item)
    {
        // open material create modal (reuse existing MaterialEditModal)
        editingMaterial = new Material { CategoryId = item.Data.Category?.Id ?? 0 };
        isMaterialEditOpen = true;
        return Task.CompletedTask;
    }

    private void HandleEditCategory(TreeItem<MaterialCategoryNode> item) { selectedCategory = item.Data.Category; isCategoryEditOpen = true; }
    private void HandleCreateCategory(TreeItem<MaterialCategoryNode> item) { selectedCategory = new MaterialCategory { ParentCategoryId = item.Data.Category?.Id }; isCategoryEditOpen = true; }
    private async Task HandleDeleteCategory(TreeItem<MaterialCategoryNode> item)
    {
        if (item?.Data.Category == null)
        {
            ToastService.ShowToast("Kategori bilgisi bulunamadı", ToastType.Error, 5000);
            return;
        }
        (bool canDelete, string? reason) = await MaterialCategoryService.CanDeleteAsync(item.Data.Category.Id);
        if (!canDelete)
        {
            ToastService.ShowToast(reason ?? "Bilinmeyen bir hata oluştu", ToastType.Error, 5000);
            return;
        }
        string categoryName = item.Data.Category.CategoryName ?? "Kategori";
        ModalService.ShowConfirmation(
            "Silme Onayı",
            $"'{categoryName}' kaydını silmek istediğinizden emin misiniz?",
            async result =>
            {
                if (result)
                {
                    var deleted = await MaterialCategoryService.DeleteAsync(item.Data.Category.Id);
                    if (deleted)
                    {
                        ToastService.ShowToast($"{categoryName} silindi", ToastType.Success, 3000);
                        categories = await MaterialCategoryService.GetAllAsync();
                        await RefreshData();
                        StateHasChanged();
                    }
                    else
                    {
                        ToastService.ShowToast($"Silme işlemi başarısız oldu", ToastType.Error, 3000);
                    }
                }
            });
    }


    private void HandleNodeSelect(TreeItem<MaterialCategoryNode>? item)
    {
        // reset state for any selection
        materialCards.Clear();
        categoryCards.Clear();
        materialTransactions.Clear();
        SelectedMaterial = null;
        selectedLocationId = null;
        displayedCategory = null;

        if (item == null)
        {
            ToastService.ShowToast("Seçim boş.", ToastType.Warning, 1500);
            StateHasChanged();
            return;
        }

        // If a material node was selected -> show material detail (existing behavior)
        if (item.Data?.Material != null)
        {
            var mat = item.Data.Material;
            materialCards.Add(mat);

            SelectedMaterial = mat;
            selectedLocationId = null; // clear location highlight on material change
            // fire-and-forget load (keeps method signature synchronous as TreeViewer expects)
            _ = LoadMaterialLocationCards(mat);
            _ = LoadMaterialTransactions(mat);

            displayedCategory = null;
        }
        else if (item?.Data?.Category != null)
        {
            // When a category node is selected, build cards for immediate subcategories and child materials
            SelectedMaterial = null;
            selectedLocationId = null;

            // Immediate subcategories (reliable: read from Categories collection)
            var subCats = categories?.Where(c => c.ParentCategoryId == item.Data.Category.Id).ToList() ?? new List<MaterialCategory>();
            if (subCats.Any())
                categoryCards.AddRange(subCats);

            // Immediate materials belonging to this category (from materials list)
            var childMats = materials?.Where(m => m.CategoryId == item.Data.Category.Id).ToList() ?? new List<Material>();
            if (childMats.Any())
                materialCards.AddRange(childMats);

            // set the displayed category (for header)
            displayedCategory = item.Data.Category;

            // ToastService.ShowToast($"Kategori seçildi: {item.Data.Category.CategoryName}", ToastType.Info, 2000);
        }

        // Provide feedback for selections
        if (item?.Data?.Category == null && item?.Data?.Material == null)
        {
            ToastService.ShowToast("Seçim boş veya bilinmeyen tür.", ToastType.Warning, 2000);
        }

        StateHasChanged();
    }

    // Find the tree node for a category and invoke selection (used by category cards)
    private void SelectCategoryCard(MaterialCategory cat)
    {
        var node = FindNodeById(categoryTree, cat.Id.ToString());
        if (node != null)
        {
            HandleNodeSelect(node);
        }
        else
        {
            // Fallback: reload data and try again
            _ = RefreshData().ContinueWith(_ =>
            {
                var n = FindNodeById(categoryTree, cat.Id.ToString());
                if (n != null) InvokeAsync(() => HandleNodeSelect(n));
            });
        }
    }

    // Called when a MaterialCard (whole card) is clicked: select material and show SelectedMaterialDetail
    private void SelectMaterialFromCard(Material mat)
    {
        if (mat == null) return;

        // mimic tree-material selection behavior
        materialCards.Clear();
        materialCards.Add(mat);

        SelectedMaterial = mat;
        selectedLocationId = null;

        // fire-and-forget loads
        _ = LoadMaterialLocationCards(mat);
        _ = LoadMaterialTransactions(mat);

        categoryCards.Clear();
        displayedCategory = null;

        StateHasChanged();
    }

    // Opens material edit (modal) from a material card in category view
    private void OpenMaterialFromCard(Material mat)
    {
        if (mat == null) return;
        editingMaterial = mat;
        isMaterialEditOpen = true;
    }

    // Loads material locations/stocks using MaterialInventory (source of truth)
    private async Task LoadMaterialLocationCards(Material mat)
    {
        selectedMaterialLocations.Clear();

        try
        {
            var inventories = materialInventories?
                .Where(mi => mi.MaterialId == mat.Id)
                .ToList() ?? new List<MaterialInventory>();

            var groups = inventories
                .GroupBy(mi => mi.LocationId)
                .Select(g => new
                {
                    LocationId = g.Key,
                    Quantity = g.Sum(x => x.Quantity),
                    UnitId = g.Select(x => x.Material?.MaterialUnitId).FirstOrDefault()
                });

            foreach (var g in groups)
            {
                var loc = g.LocationId.HasValue ? locations.FirstOrDefault(l => l.Id == g.LocationId.Value) : null;
                var unit = materialUnits.FirstOrDefault(u => u.Id == g.UnitId) ?? materialUnits.FirstOrDefault(u => u.Id == mat.MaterialUnitId);

                if (g.Quantity != 0)
                {
                    selectedMaterialLocations.Add(new MaterialLocationCard
                    {
                        LocationId = g.LocationId ?? 0,
                        LocationName = loc?.LocationName ?? (g.LocationId.HasValue ? $"Location {g.LocationId}" : "Unknown"),
                        Quantity = g.Quantity,
                        UnitName = unit?.Symbol ?? unit?.Name ?? ""
                    });
                }
            }
        }
        catch
        {
            // swallow: UI will show "no locations" if load fails
            ToastService.ShowToast("Malzeme yerleri yüklenemedi.", ToastType.Error, 3000);
        }

        StateHasChanged();
    }

    // New: Loads recent transactions (entries/exits/transfers) using MaterialMovement
    private async Task LoadMaterialTransactions(Material mat)
    {
        materialTransactions.Clear();

        try
        {
            var movements = await MaterialMovementService.GetMovementsByMaterialIdAsync(mat.Id);
            var filtered = movements
                .OrderByDescending(m => m.MovementDate)
                .Take(50)
                .ToList();

            // preload exits to resolve ExitType when movement.MovementType is null
            var allExits = await MaterialExitService.GetAllAsync();

            foreach (var m in filtered)
            {
                var fromLoc = m.FromLocationId.HasValue ? locations.FirstOrDefault(l => l.Id == m.FromLocationId.Value) : null;
                var toLoc = m.ToLocationId.HasValue ? locations.FirstOrDefault(l => l.Id == m.ToLocationId.Value) : null;

                var unit = materialUnits.FirstOrDefault(u => u.Id == m.MaterialUnitId) ?? materialUnits.FirstOrDefault(u => u.Id == mat.MaterialUnitId);

                // Determine display type and location string
                string typeLabel = m.MovementType ?? string.Empty;
                string locationLabel;
                bool isIncrease = true;

                var mt = (m.MovementType ?? string.Empty).ToLowerInvariant();
                bool looksLikeTransfer = mt.Contains("transfer") || mt.Contains("dev" ) || (m.FromLocationId.HasValue && m.ToLocationId.HasValue);
                bool looksLikeEntry = mt.Contains("entry") || mt.Contains("giriş") || (!m.FromLocationId.HasValue && m.ToLocationId.HasValue);
                bool looksLikeExit = mt.Contains("exit") || mt.Contains("çıkış") || (m.FromLocationId.HasValue && !m.ToLocationId.HasValue);

                if (looksLikeTransfer)
                {
                    typeLabel = string.IsNullOrWhiteSpace(typeLabel) ? "Transfer" : typeLabel;
                    locationLabel = $"{fromLoc?.LocationName ?? (m.FromLocationId.HasValue ? $"Loc {m.FromLocationId}" : "?")} → {toLoc?.LocationName ?? (m.ToLocationId.HasValue ? $"Loc {m.ToLocationId}" : "?")}";

                    if (selectedLocationId.HasValue)
                    {
                        if (m.ToLocationId == selectedLocationId) isIncrease = true;
                        else if (m.FromLocationId == selectedLocationId) isIncrease = false;
                        else isIncrease = true; // default
                    }
                    else
                    {
                        isIncrease = true; // generic
                    }
                }
                else if (looksLikeEntry)
                {
                    typeLabel = string.IsNullOrWhiteSpace(typeLabel) ? "Giriş" : typeLabel;
                    locationLabel = toLoc?.LocationName ?? (m.ToLocationId.HasValue ? $"Loc {m.ToLocationId}" : "?");
                    isIncrease = true;
                }
                else if (looksLikeExit)
                {
                    typeLabel = string.IsNullOrWhiteSpace(typeLabel) ? "Çıkış" : typeLabel;
                    locationLabel = fromLoc?.LocationName ?? (m.FromLocationId.HasValue ? $"Loc {m.FromLocationId}" : "?");
                    isIncrease = false;
                }
                else
                {
                    // fallback
                    typeLabel = string.IsNullOrWhiteSpace(typeLabel) ? "İşlem" : typeLabel;
                    locationLabel = toLoc?.LocationName ?? fromLoc?.LocationName ?? "Unknown";
                    isIncrease = m.ToLocationId.HasValue && !m.FromLocationId.HasValue;
                }

                materialTransactions.Add(new MaterialTransactionView
                {
                    Date = m.MovementDate,
                    Quantity = m.Quantity,
                    LocationName = locationLabel,
                    MaterialName = mat.MaterialName,
                    UnitName = unit?.Symbol ?? unit?.Name ?? string.Empty,
                    Type = typeLabel,
                    IsIncrease = isIncrease,
                    MovementTypeRaw = m.Aciklama ?? string.Empty // FIX: Avoid possible null assignment
                });
            }
        }
        catch
        {
            // ignore for UI
            ToastService.ShowToast("Malzeme işlemleri yüklenemedi.", ToastType.Error,3000);
        }

        StateHasChanged();
    }

    private void StartEntry(Material? mat, MaterialLocationCard loc)
    {
        if (mat == null || loc == null) return;

        selectedLocationId = loc.LocationId;

        editingEntry = new MaterialEntry
        {
            MaterialId = mat.Id,
            Quantity = 0,
            MaterialUnitId = mat.MaterialUnitId,
            LocationId = loc.LocationId,
            EntryDate = DateTime.Now,
            InvoiceNo = string.Empty
        };

        SelectedMaterial = mat;
        isEntryOpen = true;
        StateHasChanged();
    }

    private void StartExit(Material? mat, MaterialLocationCard loc)
    {
        if (mat == null || loc == null) return;

        selectedLocationId = loc.LocationId;

        // prepare new MaterialExit and open modal
        editingExit = new MaterialExit
        {
            MaterialId = mat.Id,
            Quantity =1,
            MaterialUnitId = mat.MaterialUnitId,
            LocationId = loc.LocationId,
            ExitDate = DateTime.Now,
            Aciklama = string.Empty
        };

        SelectedMaterial = mat;
        isExitOpen = true;
        StateHasChanged();
    }

    private void StartTransfer(Material? mat, MaterialLocationCard loc)
    {
        if (mat == null || loc == null) return;

        selectedLocationId = loc.LocationId;
        ToastService.ShowToast($"Transfer başlatıldı: {mat.MaterialName} — {loc.LocationName}", ToastType.Info, 2500);
    }

    private void ClearSearch()
    {
        searchTerm = "";
        SelectedMaterial = null;
        selectedMaterialLocations.Clear();
        materialTransactions.Clear();
        selectedLocationId = null;
        materialCards.Clear();
        categoryCards.Clear();
        displayedCategory = null;
        StateHasChanged();
    }

    private async Task OpenEntryModalWithMaterial(Material mat)
    {
        editingEntry = new MaterialEntry
        {
            MaterialId = mat.Id,
            Quantity = 0,
            MaterialUnitId = mat.MaterialUnitId,
            LocationId = 0,
            EntryDate = DateTime.Now,
            InvoiceNo = string.Empty
        };
        SelectedMaterial = mat;
        isEntryOpen = true;
        StateHasChanged();
        await Task.CompletedTask;
    }

    private void OpenEntryModal(Material? mat)
    {
        if (mat != null)
        {
            _ = OpenEntryModalWithMaterial(mat);
            return;
        }
        editingEntry = new MaterialEntry { EntryDate = DateTime.Now };
        SelectedMaterial = null;
        isEntryOpen = true;
    }

    private void CloseEntryModal()
    {
        isEntryOpen = false;
        editingEntry = null;
    }

    private async Task OnEntryModalSave()
    {
        if (editingEntry == null)
            return;

        if (editingEntry.LocationId == 0)
        {
            ToastService.ShowToast("Lütfen Malzeme Yeri seçiniz.", ToastType.Warning, 3000);
            return;
        }

        try
        {
            string? currentUserName = httpContextAccessor.HttpContext?.User?.Identity?.Name;
            var created = await MaterialEntryService.AddAsync(editingEntry, currentUserName,
                                CancellationToken.None);
            ToastService.ShowToast("Giriş kaydedildi.", ToastType.Success, 3000);

            CloseEntryModal();

            // Refresh only inventories so we don't reset the selected material / UI state.
            materialInventories = await MaterialInventoryService.GetAllAsync();

            if (SelectedMaterial != null)
            {
                // reload locations and transactions for the currently selected material
                await LoadMaterialLocationCards(SelectedMaterial);
                await LoadMaterialTransactions(SelectedMaterial);
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"Kaydetme sırasında hata: {ex.Message}", ToastType.Error, 5000);
        }
    }

    private async Task OnExitModalSave()
    {
        if (editingExit == null)
            return;

        if (editingExit.LocationId == 0)
        {
            ToastService.ShowToast("Lütfen Malzeme Yeri seçiniz.", ToastType.Warning, 3000);
            return;
        }

        try
        {
            await MaterialExitService.AddAsync(editingExit, CancellationToken.None);
            ToastService.ShowToast("Çıkış kaydedildi.", ToastType.Success, 3000);

            CloseExitModal();

            // After exit, refresh inventories only to keep the UI selection intact
            materialInventories = await MaterialInventoryService.GetAllAsync();

            if (SelectedMaterial != null)
            {
                await LoadMaterialLocationCards(SelectedMaterial);
                await LoadMaterialTransactions(SelectedMaterial);
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"Kaydetme sırasında hata: {ex.Message}", ToastType.Error, 5000);
        }
    }
    private void CloseExitModal()
    {
        isExitOpen = false;
        editingEntry = null;
    }

    private async Task OnCategoryModalSave()
    {
        isCategoryEditOpen = false;
        if (selectedCategory != null)
        {
            if (selectedCategory.Id == 0)
            {
                await MaterialCategoryService.AddAsync(selectedCategory);
                ToastService.ShowToast($"{selectedCategory.CategoryName} eklendi", ToastType.Success, 3000);
            }
            else
            {
                await MaterialCategoryService.UpdateAsync(selectedCategory);
                ToastService.ShowToast($"{selectedCategory.CategoryName} güncellendi", ToastType.Info, 3000);
            }
            await RefreshData();
        }
    }

    private void CloseCategoryModal() { isCategoryEditOpen = false; selectedCategory = null; }

    private async Task OnMaterialModalSave()
    {
        isMaterialEditOpen = false;
        if (editingMaterial != null)
        {
            if (editingMaterial.Id == 0)
            {
                await MaterialService.AddAsync(editingMaterial);
                ToastService.ShowToast($"{editingMaterial.MaterialName} eklendi", ToastType.Success, 3000);
            }
            else
            {
                await MaterialService.UpdateAsync(editingMaterial);
                ToastService.ShowToast($"{editingMaterial.MaterialName} güncellendi", ToastType.Info, 3000);
            }
            await RefreshData();
        }
    }

    private void CloseMaterialModal() { isMaterialEditOpen = false; editingMaterial = null; }

    private string GetSelectedMaterialUnitSymbol()
    {
        if (SelectedMaterial == null) return string.Empty;
        var unit = materialUnits.FirstOrDefault(u => u.Id == SelectedMaterial.MaterialUnitId);
        return unit?.Symbol ?? unit?.Name ?? string.Empty;
    }

    // Data models
    public class MaterialCategoryNode
    {
        public MaterialCategory? Category { get; set; }
        public Material? Material { get; set; }
    }

}   