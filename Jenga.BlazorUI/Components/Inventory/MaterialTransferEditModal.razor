@using Jenga.DataAccess.Services.Inventory
@using Jenga.Models.Inventory
@using Jenga.Utility.Toast
@inject IMaterialService MaterialService
@inject IMaterialTransferService MaterialTransferService
@inject IToastService ToastService
@if (IsOpen)
{
    <div class="modal show" tabindex="-1" style="display: block;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Malzeme Transferi</h5>
                    <button type="button" class="close" @onclick="OnClose" aria-label="Kapat">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <label>Malzeme</label>
                        <select class="form-select" @bind="MaterialId" @bind:event="onchange">
                            <option value="">Malzeme seçiniz</option>
                            @foreach (var mat in Materials)
                            {
                                <option value="@mat.Id">@mat.MaterialName</option>
                            }
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>Miktar</label>
                        <input class="form-control" @bind="MaterialTransfer!.Quantity" type="number" min="1" />
                        @if (ShowQuantityError)
                        {
                            <div class="text-danger small mt-1">Miktar en az 1 olmalıdır.</div>
                        }
                        @if (MaterialTransfer != null && MaterialTransfer.FromLocationId !=0)
                        {
                            <div class="small text-muted mt-1">Mevcut stok: <strong>@AvailableQuantity</strong></div>
                            @if (ShowExceedsError)
                            {
                                <div class="text-danger small mt-1">Girilen miktar seçili çıkış yerindeki mevcut stoktan fazla olamaz.</div>
                            }
                        }
                    </div>
                    <div class="mb-2">
                        <label>Birim</label>
                        <select class="form-select" @bind="MaterialTransfer!.MaterialUnitId" disabled>
                            <option value="">Birim seçiniz</option>
                            @foreach (var unit in MaterialUnits)
                            {
                                <option value="@unit.Id">@unit.Name (@unit.Symbol)</option>
                            }
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>Nereden</label>
                        @{
                            var selectedMaterialId = MaterialTransfer?.MaterialId ??0;
                            var locationQuantities = MaterialInventories?
                                .Where(mi => mi.MaterialId == selectedMaterialId && mi.LocationId.HasValue)
                                .GroupBy(mi => mi.LocationId!.Value)
                                .ToDictionary(g => g.Key, g => g.Sum(mi => mi.Quantity))
                                ?? new Dictionary<int, int>();

                            var locationQuantitiesFiltered = locationQuantities.Where(kv => kv.Value >0).ToDictionary(kv => kv.Key, kv => kv.Value);
                            var availableLocationIds = locationQuantitiesFiltered.Keys.ToList();

                            var availableLocations = Locations?.Where(loc => availableLocationIds.Contains(loc.Id)).ToList() ?? new List<Location>();

                            var selectedMaterial = Materials.FirstOrDefault(m => m.Id == selectedMaterialId);
                            var selectedUnitName = selectedMaterial is not null
                                ? MaterialUnits.FirstOrDefault(u => u.Id == selectedMaterial.MaterialUnitId)?.Name
                                : null;
                        }
                        <select class="form-select" @bind="MaterialTransfer.FromLocationId">
                            <option value="">Kaynak lokasyon seçiniz</option>
                            @foreach (var loc in availableLocations)
                            {
                                var qty = locationQuantitiesFiltered.TryGetValue(loc.Id, out var q) ? q :0;
                                <option value="@loc.Id">@GetFullLocationName(loc) (@qty @(selectedUnitName ?? ""))</option>
                            }
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>Nereye</label>
                        @{
                            // reuse same availableLocations and unit name for destination list
                        }
                        <select class="form-select" @bind="MaterialTransfer.ToLocationId">
                            <option value="">Hedef lokasyon seçiniz</option>
                            @foreach (var loc in Locations)
                            {
                                // Allow destination locations to be any storage place (even if currently zero), but prefer showing parents and names.
                                <option value="@loc.Id">@GetFullLocationName(loc)</option>
                            }
                        </select>
                        @if (ShowToLocationError)
                        {
                            <div class="text-danger small mt-1">Lütfen hedef lokasyon seçiniz.</div>
                        }
                    </div>
                    <div class="mb-2">
                        <label>Tarih</label>
                        <input class="form-control" @bind="MaterialTransfer!.TransferDate" type="date" />
                    </div>
                    <div class="mb-2">
                        <label>Açıklama</label>
                        <textarea class="form-control" rows="3" @bind="MaterialTransfer.Aciklama"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-warning" @onclick="HandleSave" disabled="@IsSaveDisabled">Transfer Et</button>
                    <button class="btn btn-secondary" @onclick="OnClose">Kapat</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public MaterialTransfer? MaterialTransfer { get; set; }
    [Parameter] public List<MaterialUnit> MaterialUnits { get; set; } = new();
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback OnSave { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public List<Material> Materials { get; set; } = new();
    [Parameter] public List<Location> Locations { get; set; } = new();
    [Parameter] public List<MaterialInventory>? MaterialInventories { get; set; }

    private int _materialId;
    private int MaterialId
    {
        get => MaterialTransfer!.MaterialId;
        set
        {
            MaterialTransfer!.MaterialId = value;
            var selectedMaterial = Materials.FirstOrDefault(m => m.Id == value);
            if (selectedMaterial != null)
            {
                MaterialTransfer!.MaterialUnitId = selectedMaterial.MaterialUnitId;
            }
        }
    }
    private int AvailableQuantity
    {
        get
        {
            if (MaterialTransfer == null || MaterialInventories == null || MaterialTransfer.FromLocationId ==0) return 0;
            return MaterialInventories
                .Where(mi => mi.MaterialId == MaterialTransfer.MaterialId && mi.LocationId == MaterialTransfer.FromLocationId)
                .Sum(mi => mi.Quantity);
        }
    }
    private bool ShowExceedsError => MaterialTransfer != null && MaterialTransfer.FromLocationId !=0 && MaterialTransfer.Quantity > AvailableQuantity;

    private bool IsSaveDisabled => MaterialTransfer == null || MaterialTransfer.FromLocationId ==0 || MaterialTransfer.ToLocationId ==0 || MaterialTransfer.Quantity <1 || MaterialTransfer.FromLocationId == MaterialTransfer.ToLocationId;
    private bool ShowQuantityError => MaterialTransfer != null && MaterialTransfer.Quantity <1;
    private bool ShowToLocationError => MaterialTransfer != null && MaterialTransfer.ToLocationId ==0;

    private async Task HandleSave()
    {
        if (MaterialTransfer == null)
        {
            ToastService.ShowWarning("Geçerli bir transfer kaydı bulunamadı.");
            return;
        }
        if (MaterialTransfer.FromLocationId ==0 || MaterialTransfer.ToLocationId ==0)
        {
            ToastService.ShowWarning("Lütfen kaynak ve hedef lokasyon seçiniz.");
            return;
        }
        if (MaterialTransfer.FromLocationId == MaterialTransfer.ToLocationId)
        {
            ToastService.ShowWarning("Kaynak ve hedef lokasyon aynı olamaz.");
            return;
        }
        if (MaterialTransfer.Quantity <1)
        {
            ToastService.ShowWarning("Miktar en az1 olmalıdır.");
            return;
        }
        await OnSave.InvokeAsync();
    }

    private string GetFullLocationName(Location loc)
    {
        if (loc == null) return string.Empty;
        var parts = new List<string>();
        var current = loc;
        while (current != null)
        {
            parts.Add(current.LocationName);
            if (current.ParentId.HasValue)
            {
                current = Locations.FirstOrDefault(l => l.Id == current.ParentId.Value);
            }
            else
            {
                current = null;
            }
        }
        parts.Reverse();
        return string.Join(" > ", parts);
    }
}
