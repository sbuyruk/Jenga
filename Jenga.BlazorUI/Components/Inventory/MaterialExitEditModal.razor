@using Jenga.DataAccess.Services.Inventory
@using Jenga.Models.Enums
@using Jenga.Models.Inventory
@using Jenga.Utility.Helpers
@using Jenga.Utility.Toast
@inject IMaterialService MaterialService
@inject IMaterialExitService MaterialExitService
@inject IToastService ToastService
@if (IsOpen)
{
    <div class="modal show" tabindex="-1" style="display: block;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Malzeme Çıkış Düzenle</h5>
                    <button type="button" class="close" @onclick="OnClose" aria-label="Kapat">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <label>Malzeme</label>
                        <select class="form-select" @bind="MaterialId" @bind:event="onchange">
                            <option value="">Malzeme seçiniz</option>
                            @foreach (var mat in Materials)
                            {
                                <option value="@mat.Id">@mat.MaterialName</option>
                            }
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>Miktar</label>
                        <input class="form-control" type="number" @bind="MaterialExit.Quantity" min="1" />
                    </div>
                    <div class="mb-2">
                        <label>Birim</label>
                        <select class="form-select" @bind="MaterialExit!.MaterialUnitId" disabled>
                            <option value="">Birim seçiniz</option>
                            @foreach (var unit in MaterialUnits)
                            {
                                <option value="@unit.Id">@unit.Name (@unit.Symbol)</option>
                            }
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>Lokasyon</label>
                        @{
                            // Seçilen malzemenin bulunduğu lokasyonları bul
                            var availableLocationIds = MaterialInventories
                                .Where(mi => mi.MaterialId == MaterialExit.MaterialId)
                                .Select(mi => mi.LocationId)
                                .Distinct()
                                .ToList();

                            var availableLocations = Locations
                                .Where(loc => availableLocationIds.Contains(loc.Id))
                                .ToList();
                        }
                        <select class="form-select" @bind="MaterialExit.LocationId">
                            <option value="">Lokasyon seçiniz</option>
                            @foreach (var loc in availableLocations)
                            {
                                <option value="@loc.Id">@loc.LocationName</option>
                            }
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>Çıkış Tipi</label>
                        <select class="form-select" @bind="MaterialExit.ExitType">
                            @foreach (MaterialExitType type in Enum.GetValues(typeof(MaterialExitType)))
                            {
                                <option value="@type.ToString()">@EnumHelper.GetEnumDescription(type)</option>
                            }

                        </select>
                    </div>
                    <div class="mb-2">
                        <label>Tarih</label>
                        <input class="form-control" type="date" @bind="MaterialExit.ExitDate" />
                    </div>
                    <div class="mb-2">
                        <label>Açıklama</label>
                        <input class="form-control" @bind="MaterialExit.Aciklama" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" @onclick="HandleSave" disabled="@IsSaveDisabled">Kaydet</button>
                    <button class="btn btn-secondary" @onclick="OnClose">Kapat</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public MaterialExit MaterialExit { get; set; }
    [Parameter] public List<Material> Materials { get; set; } = new();
    [Parameter] public List<MaterialUnit> MaterialUnits { get; set; } = new();
    [Parameter] public List<Location> Locations { get; set; } = new();
    [Parameter] public List<MaterialInventory> MaterialInventories { get; set; } = new();
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback OnSave { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private int _materialId;
    private int MaterialId
    {
        get => MaterialExit!.MaterialId;
        set
        {
            MaterialExit!.MaterialId = value;
            var selectedMaterial = Materials.FirstOrDefault(m => m.Id == value);
            if (selectedMaterial != null)
            {
                MaterialExit!.MaterialUnitId = selectedMaterial.MaterialUnitId;
            }
        }
    }
    private bool IsSaveDisabled => MaterialExit?.LocationId == 0;

    private async Task HandleSave()
    {
        if (MaterialExit?.LocationId == 0)
        {
            ToastService.ShowWarning("Lütfen Malzeme Yeri seçiniz.");
            return;
        }
        await OnSave.InvokeAsync();
    }
}