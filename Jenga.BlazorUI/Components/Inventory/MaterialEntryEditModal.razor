@using Jenga.DataAccess.Services.Inventory
@using Jenga.Models.Inventory
@using Jenga.Utility.Toast
@inject IMaterialService MaterialService
@inject IMaterialEntryService MaterialEntryService
@inject IToastService ToastService
@if (IsOpen)
{
    <div class="modal show" tabindex="-1" style="display: block;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@ModalTitle</h5>
                    <button type="button" class="close" @onclick="OnClose" aria-label="Kapat">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <label>Malzeme</label>
                        <select class="form-select" @bind="MaterialId" @bind:event="onchange">
                            <option value="">Malzeme seçiniz</option>
                            @foreach (var mat in Materials)
                            {
                                <option value="@mat.Id">@mat.MaterialName</option>
                            }
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>Miktar</label>
                        <input class="form-control" @bind="MaterialEntry!.Quantity" type="number" min="1" />
                        @if (ShowQuantityError)
                        {
                            <div class="text-danger small mt-1">Miktar en az 1 olmalıdır.</div>
                        }
                    </div>
                    <div class="mb-2">
                        <label>Birim</label>
                        <select class="form-select" @bind="MaterialEntry!.MaterialUnitId" disabled>
                            <option value="">Birim seçiniz</option>
                            @foreach (var unit in MaterialUnits)
                            {
                                <option value="@unit.Id">@unit.Name (@unit.Symbol)</option>
                            }
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>Malzeme Yeri</label>
                        <select class="form-select" @bind="MaterialEntry!.LocationId">
                            <option value="">Malzeme Yeri seçiniz</option>
                            @if (ParentLocations != null)
                            {
                                @foreach (var parentLoc in ParentLocations.Where(x => x.IsStoragePlace))
                                {
                                    <option value="@parentLoc.Id">
                                        @GetLocationPath(parentLoc)
                                    </option>
                                }
                            }
                        </select>
                        @if (ShowLocationError)
                        {
                            <div class="text-danger small mt-1">Lütfen Malzeme Yeri seçiniz.</div>
                        }

                    </div>
                    <div class="mb-2">
                        <label>Tarih</label>
                        <input class="form-control" @bind="MaterialEntry!.EntryDate" type="date" />
                    </div>
                    <div class="mb-2">
                        <label>Belge No</label>
                        <input class="form-control" @bind="MaterialEntry!.InvoiceNo" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" @onclick="HandleSave" disabled="@IsSaveDisabled">Kaydet</button>
                    <button class="btn btn-secondary" @onclick="OnClose">Kapat</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public MaterialEntry? MaterialEntry { get; set; }
    [Parameter] public List<MaterialUnit> MaterialUnits { get; set; } = new();
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback OnSave { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public List<Material> Materials { get; set; } = new();
    [Parameter] public List<Location> Locations { get; set; } = new();

    public List<Location>? ParentLocations ;
    protected override void OnParametersSet()
    {
        ParentLocations = Locations;
    }
    private int _materialId;
    private int MaterialId
    {
        get => MaterialEntry!.MaterialId;
        set
        {
            MaterialEntry!.MaterialId = value;
            var selectedMaterial = Materials.FirstOrDefault(m => m.Id == value);
            if (selectedMaterial != null)
            {
                MaterialEntry!.MaterialUnitId = selectedMaterial.MaterialUnitId;
            }
        }
    }

    // Disable save when there is no entry, location is not selected (0) or quantity is less than1
    private bool IsSaveDisabled => MaterialEntry == null || MaterialEntry.LocationId ==0 || MaterialEntry.Quantity <1;

    private bool ShowQuantityError => MaterialEntry != null && MaterialEntry.Quantity <1;
    private bool ShowLocationError => MaterialEntry != null && MaterialEntry.LocationId ==0;

    private string ModalTitle => MaterialEntry == null || MaterialEntry.Id ==0 ? "Envantere Malzeme Girişi" : "Malzeme Girişi Düzenle";

    private async Task HandleSave()
    {
        if (MaterialEntry == null)
        {
            ToastService.ShowWarning("Geçerli bir malzeme girişi bulunamadı.");
            return;
        }

        if (MaterialEntry.LocationId ==0)
        {
            ToastService.ShowWarning("Lütfen Malzeme Yeri seçiniz.");
            return;
        }

        if (MaterialEntry.Quantity <1)
        {
            ToastService.ShowWarning("Lütfen Miktar1 veya daha fazla giriniz.");
            return;
        }
        await OnSave.InvokeAsync();
    }
    private string GetLocationPath(Location loc)
    {
        var names = new List<string>();
        var current = loc;
        while (current != null)
        {
            // names.Insert(0, $"{current.LocationName} ({current.LocationType})");
            names.Insert(0, $"{current.LocationName} ");
            current = ParentLocations?.FirstOrDefault(x => x.Id == current.ParentId);
        }
        return string.Join(" > ", names);
    }
}