@inject NavigationManager Nav
@using Jenga.Models.Common
@inject ILogger<RecursiveMenu> Logger
@implements IDisposable

<ul class="recursive-menu">
    @foreach (var item in Items!)
    {
        // item.Url null ise boş string kullan veya direkt false döndür
        var url = item.Url ?? string.Empty;

        <li class="menu-item @(IsExpandedItem?.Invoke(item) == true ? "open" : "") @(item.IsActive ? "active" : "")"
            style="border: 1px solid @(item.IsActive ? "red" : "transparent")">
            <a href="@item.Url"
               @onclick="() => ToggleItem.InvokeAsync(item)"
            @onclick:preventDefault>
                @item.Title 
                @if (item.Children?.Any() == true)
                {
                    <span class="toggle-icon">▶</span>
                }
            </a>

@*             @if (IsExpandedItem?.Invoke(item) == true && item.Children?.Any() == true)
            {
                <RecursiveMenu Items="item.Children"
                               ToggleItem="ToggleItem"
                               IsExpandedItem="IsExpandedItem" />

            } *@
            @if (IsExpandedItem?.Invoke(item) == true && item.Children?.Any() == true)
            {
                <ul class="submenu show">
                    @item.Title @* debug amacıyla *@
                    <RecursiveMenu Items="item.Children"
                                   ToggleItem="ToggleItem"
                                   IsExpandedItem="IsExpandedItem" />
                </ul>
            }

        </li>
    }
</ul>

@code {
    [Parameter] public List<MenuItem>? Items { get; set; }
    [Parameter] public EventCallback<MenuItem> ToggleItem { get; set; }
    [Parameter] public Func<MenuItem, bool>? IsExpandedItem { get; set; }


    // Güncellenmiş Toggle metodu kaldırılıyor (merkezden çağrılacak)

    private void SetActiveRecursive(List<MenuItem> items)
    {
        var fullUri = Nav.Uri.ToLowerInvariant();
        var currentUrl = Nav.ToBaseRelativePath(Nav.Uri).TrimStart('/').ToLowerInvariant();

        foreach (var item in items)
        {
            var normalizedItemUrl = item.Url?.TrimStart('/').ToLowerInvariant();

            item.IsActive =
                (!string.IsNullOrWhiteSpace(normalizedItemUrl) &&
                 (currentUrl == normalizedItemUrl || fullUri.EndsWith(normalizedItemUrl)));

            if (item.Children?.Any() == true)
            {
                SetActiveRecursive(item.Children);
                if (item.Children.Any(c => c.IsActive))
                    item.IsActive = true;
            }
        }
    }



    public void Dispose()
    {
        // Bellek sızıntısını önlemek için aboneliği kaldır
        Nav.LocationChanged -= OnLocationChanged;
    }

    



}
